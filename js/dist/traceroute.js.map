{"version":3,"sources":["../src/traceroute.js"],"names":["define","map","wuk","u","note","ws","path","baseRoot","openCallback","coefficient","nodes","links","msgCounter","noteMsgs","scanBtn","cancelBtn","filter","data","newLinks","newNodes","diffNodes","diffLinks","Object","keys","forEach","k","abort","isEmptyObj","close","closeModal","UIkit","modal","isActive","toggle","closeSidebar","sb","$","is","prepare","clear","onopen","e","cb","console","log","init","success","processing","process","isFn","onmessage","isStr","JSON","parse","nodesLen","length","linksLen","x","width","y","height","draw","undefined","onerror","error","onclose","enable","info","addHandlers","fn","createSock","opt","WebSocket","trace","arr","disable","send","stringify"],"mappings":"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","file":"traceroute.js","sourcesContent":["define(['map/mediator', 'core/wuk', 'core/util'], function (map, wuk, u) { // wpix, tpl, wuk, u\r\n\tvar note = wuk.note,\r\n\t\tws = {},\r\n\t\tpath = 'ws://'+ baseRoot +'/network/icmp/traceroute', // window.location.host\r\n\t\topenCallback,\r\n\t\tcoefficient = {},\r\n\t\tnodes = {},\r\n\t\tlinks = {},\r\n\t\tmsgCounter = 0,\r\n\t\tnoteMsgs = {},\r\n\t\tscanBtn = {},\r\n\t\tcancelBtn = {};\r\n\t\r\n\t// var v = prompt('change the address if you want:', path);\r\n\t// if (v) { path = v;}\r\n\t\r\n\tfunction filter(data) {\r\n\t\tvar newLinks = data.links,\r\n\t\t\tnewNodes = data.nodes,\r\n\t\t\tdiffNodes = {},\r\n\t\t\tdiffLinks = {};\r\n\t\t\t\r\n\t\tObject.keys(newNodes).forEach(function (k) {\r\n\t\t\tif ( !nodes[k] ) {\r\n\t\t\t\tnodes[k] = newNodes[k];\r\n\t\t\t\tdiffNodes[k] = newNodes[k];\r\n\t\t\t}\r\n\t\t});\r\n\t\tObject.keys(newLinks).forEach(function (k) {\r\n\t\t\tif ( !links[k] ) {\r\n\t\t\t\tlinks[k] = newLinks[k];\r\n\t\t\t\tdiffLinks[k] = newLinks[k];\r\n\t\t\t}\r\n\t\t});\r\n\t\t\r\n\t\treturn {\r\n\t\t\tlinks: diffLinks,\r\n\t\t\tnodes: diffNodes\r\n\t\t};\r\n\t}\r\n\tfunction abort() {\r\n\t\tif ( !u.isEmptyObj(ws) ) {\r\n\t\t\tws.close(4999);\r\n\t\t}\r\n\t}\r\n\tfunction closeModal() {\r\n\t\tvar u;\r\n\t\t// $('#newSide').toggle('slide');\r\n\t\t// $(\"body\").trigger( $.Event(\"keydown\", { keyCode: 27 }) );\r\n\t\t\r\n\t\tu = UIkit.modal('#modal_traceroute')[0];\r\n\t\tif ( u.isActive() ) {\r\n\t\t\tu.toggle('close');\r\n\t\t}\r\n\t}\r\n\tfunction closeSidebar() {\r\n\t\tvar sb = $('#newSide')\r\n\t\t\r\n\t\tif ( sb.is(':visible') ) {\r\n\t\t\tsb.toggle('slide');\r\n\t\t}\r\n\t}\r\n\tfunction prepare() {\r\n\t\t/* wpix.clearContainer(\"viewport\");\r\n\t\twpix.mainContainer.x = wpix.renderer.width / 2;\r\n\t\twpix.mainContainer.y = wpix.renderer.height / 2; */\r\n\t\t\r\n\t\tmap.clear();\r\n\t\t// map.setPosition(map.width/2, map.height/2);\r\n\t\t\r\n\t\tcloseModal();\r\n\t\tcloseSidebar();\r\n\t}\r\n\tfunction onopen(e) {\r\n\t\tvar cb = openCallback;\r\n\t\t\r\n\t\tconsole.log(\"Connection open...\");\r\n\t\t\r\n\t\tnoteMsgs.init.close();\r\n\t\t\r\n\t\tnote.success('Socket connected.');\r\n\t\t\r\n\t\tnoteMsgs.processing = note.process('Waiting for socket messages...', 0);\r\n\t\t\r\n\t\t\r\n\t\t\t\r\n\t\t// ws.send(\"Hello WebSocket!\");\r\n\t\t\r\n\t\tif ( u.isFn(cb) ) {\r\n\t\t\tcb();\r\n\t\t}\r\n\t}\r\n\tfunction onmessage(e) {\r\n\t\tvar data;\r\n\t\tmsgCounter += 1;\r\n\t\t\t\r\n\t\tif (msgCounter === 1) { // first message\r\n\t\t\tprepare();\r\n\t\t}\r\n\t\t\r\n\t\tif ( u.isStr(e.data) ) {\r\n\t\t\tconsole.log(\"String message received\\n\");\r\n\t\t\tnote.success('New socket message received.');\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tdata = JSON.parse(e.data);\r\n\t\t\tconsole.log(data);\r\n\t\t\t\r\n\t\t\tdata = filter(data);\r\n\t\t\t\r\n\t\t\tvar nodesLen = Object.keys(data.nodes).length;\r\n\t\t\tvar linksLen = Object.keys(data.links).length;\r\n\t\t\t\r\n\t\t\tconsole.log(nodesLen, linksLen);\r\n\t\t\t\r\n\t\t\tcoefficient = {\r\n\t\t\t\tx: map.width / (300 + 80), // 600 80  wpix.renderer.width\r\n\t\t\t\ty: map.height / (300 + 80), // 600 80 wpix.renderer.height\r\n\t\t\t}\r\n\t\t\t// console.log(coefficient);\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tif (msgCounter === 1) {\r\n\t\t\t\tconsole.log('fud');\r\n\t\t\t//\ttpl.draw(data, \"viewport\", undefined, coefficient, true);\r\n\t\t\t\tmap.draw(data, \"viewport\", undefined, coefficient, true);\r\n\t\t\t} else {\r\n\t\t\t//\ttpl.draw(data, \"viewport\", undefined, coefficient);\r\n\t\t\t\tmap.draw(data, \"viewport\", undefined, coefficient);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconsole.log(\"Other message received\\n\", e.data);\r\n\t\t}\r\n\t}\r\n\tfunction onerror(e) {\r\n\t\tconsole.log(\"WebSocket Error: \" , e);\r\n\t\t\r\n\t\tcloseModal();\r\n\t\t\r\n\t\tnoteMsgs.init.close();\r\n\t\t// noteMsgs.processing.close();\r\n\t\t\r\n\t\tnote.error('Socket error.');\r\n\t\t\r\n\t}\r\n\tfunction onclose(e) {\r\n\t\tconsole.log(\"Connection closed\", e);\r\n\t\twuk.enable(scanBtn);\r\n\t\t\r\n\t\t\r\n\t\tnoteMsgs.init.close();\r\n\t\t\r\n\t\tvar process = noteMsgs.processing;\r\n\t\tif (process) {\r\n\t\t\tprocess.close();\r\n\t\t}\r\n\t\t\r\n\t\tnote.info('Socket closed.', 2000);\r\n\r\n\t}\r\n\tfunction addHandlers(fn) {\r\n\t\topenCallback = fn;\r\n\t\t\r\n\t\tws.onopen = onopen;\r\n\t\tws.onmessage = onmessage;\r\n\t\tws.onerror = onerror;\r\n\t\tws.onclose = onclose;\r\n\t}\r\n\tfunction createSock(opt) {\r\n\t\tif (opt) { \r\n\t\t\tpath += '?portscanner=true';\r\n\t\t}\r\n\t\tws = new WebSocket(path);\r\n\t\tconsole.log(ws);\r\n\t}\r\n\tfunction trace(arr, opt) {\r\n\t\tnoteMsgs.init = wuk.note.process('Opening socket...', false, 'top-center');\r\n\t\t\r\n\t\tscanBtn = $('#traceroute_scan');\r\n\t\tcancelBtn = $('#traceroute_scan');\r\n\t\twuk.disable(scanBtn);\r\n\t\t\r\n\t\tcreateSock(opt);\r\n\t\taddHandlers(function () {\r\n\t\t\tws.send( JSON.stringify(arr) );\r\n\t\t});\r\n\t\t\r\n\t}\r\n\t\r\n\treturn {\r\n\t\tabort: abort,\r\n\t\ttrace: trace\r\n\t};\r\n\t\r\n});"]}