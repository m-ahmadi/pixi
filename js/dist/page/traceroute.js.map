{"version":3,"sources":["../../src/page/traceroute.js"],"names":["define","map","wuk","u","note","ws","path","baseRoot","openCallback","coefficient","nodes","links","msgCounter","noteMsgs","scanBtn","cancelBtn","filter","data","newLinks","newNodes","diffNodes","diffLinks","Object","keys","forEach","k","abort","isEmptyObj","close","closeModal","begin","openModal","closeSidebar","sb","$","is","toggle","prepare","clear","onopen","e","cb","console","log","init","success","processing","process","isFn","onmessage","isStr","JSON","parse","nodesLen","length","linksLen","x","width","y","height","draw","undefined","onerror","error","onclose","enable","info","addHandlers","fn","createSock","opt","WebSocket","trace","arr","disable","send","stringify","on","txtarea","checkbox","txt","preventDefault","val","trim","split","removeAttr"],"mappings":"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","file":"traceroute.js","sourcesContent":["define(['map/mediator', 'core/wuk', 'core/util'], function (map, wuk, u) { // wpix, tpl, wuk, u\r\n\tvar note = wuk.note,\r\n\t\tws = {},\r\n\t\tpath = 'ws://'+ baseRoot +'/network/icmp/traceroute', // window.location.host\r\n\t\topenCallback,\r\n\t\tcoefficient = {},\r\n\t\tnodes = {},\r\n\t\tlinks = {},\r\n\t\tmsgCounter = 0,\r\n\t\tnoteMsgs = {},\r\n\t\tscanBtn = {},\r\n\t\tcancelBtn = {};\r\n\t\r\n\t// var v = prompt('change the address if you want:', path);\r\n\t// if (v) { path = v;}\r\n\t\r\n\tfunction filter(data) {\r\n\t\tvar newLinks = data.links,\r\n\t\t\tnewNodes = data.nodes,\r\n\t\t\tdiffNodes = {},\r\n\t\t\tdiffLinks = {};\r\n\t\t\t\r\n\t\tObject.keys(newNodes).forEach(function (k) {\r\n\t\t\tif ( !nodes[k] ) {\r\n\t\t\t\tnodes[k] = newNodes[k];\r\n\t\t\t\tdiffNodes[k] = newNodes[k];\r\n\t\t\t}\r\n\t\t});\r\n\t\tObject.keys(newLinks).forEach(function (k) {\r\n\t\t\tif ( !links[k] ) {\r\n\t\t\t\tlinks[k] = newLinks[k];\r\n\t\t\t\tdiffLinks[k] = newLinks[k];\r\n\t\t\t}\r\n\t\t});\r\n\t\t\r\n\t\treturn {\r\n\t\t\tlinks: diffLinks,\r\n\t\t\tnodes: diffNodes\r\n\t\t};\r\n\t}\r\n\tfunction abort() {\r\n\t\tif ( !u.isEmptyObj(ws) ) {\r\n\t\t\tws.close(4999);\r\n\t\t}\r\n\t}\r\n\tfunction closeModal() {\r\n\t\twuk.closeModal(\"#modal_traceroute\");\r\n\t}\r\n\tfunction begin() {\r\n\t\twuk.openModal(\"#modal_traceroute\");\r\n\t}\r\n\tfunction closeSidebar() {\r\n\t\tvar sb = $('#newSide')\r\n\t\t\r\n\t\tif ( sb.is(':visible') ) {\r\n\t\t\tsb.toggle('slide');\r\n\t\t}\r\n\t}\r\n\tfunction prepare() {\r\n\t\t/* wpix.clearContainer(\"viewport\");\r\n\t\twpix.mainContainer.x = wpix.renderer.width / 2;\r\n\t\twpix.mainContainer.y = wpix.renderer.height / 2; */\r\n\t\t\r\n\t\tmap.clear();\r\n\t\t// map.setPosition(map.width/2, map.height/2);\r\n\t\t\r\n\t\tcloseModal();\r\n\t\tcloseSidebar();\r\n\t}\r\n\tfunction onopen(e) {\r\n\t\tvar cb = openCallback;\r\n\t\t\r\n\t\tconsole.log(\"Connection open...\");\r\n\t\t\r\n\t\tnoteMsgs.init.close();\r\n\t\t\r\n\t\tnote.success('Socket connected.');\r\n\t\t\r\n\t\tnoteMsgs.processing = note.process('Waiting for socket messages...', 0);\r\n\t\t\r\n\t\t\r\n\t\t\t\r\n\t\t// ws.send(\"Hello WebSocket!\");\r\n\t\t\r\n\t\tif ( u.isFn(cb) ) {\r\n\t\t\tcb();\r\n\t\t}\r\n\t}\r\n\tfunction onmessage(e) {\r\n\t\tvar data;\r\n\t\tmsgCounter += 1;\r\n\t\t\t\r\n\t\tif (msgCounter === 1) { // first message\r\n\t\t\tprepare();\r\n\t\t}\r\n\t\t\r\n\t\tif ( u.isStr(e.data) ) {\r\n\t\t\tconsole.log(\"String message received\\n\");\r\n\t\t\tnote.success('New socket message received.');\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tdata = JSON.parse(e.data);\r\n\t\t\tconsole.log(data);\r\n\t\t\t\r\n\t\t\tdata = filter(data);\r\n\t\t\t\r\n\t\t\tvar nodesLen = Object.keys(data.nodes).length;\r\n\t\t\tvar linksLen = Object.keys(data.links).length;\r\n\t\t\t\r\n\t\t\tconsole.log(nodesLen, linksLen);\r\n\t\t\t\r\n\t\t\tcoefficient = {\r\n\t\t\t\tx: map.width / (300 + 80), // 600 80  wpix.renderer.width\r\n\t\t\t\ty: map.height / (300 + 80), // 600 80 wpix.renderer.height\r\n\t\t\t}\r\n\t\t\t// console.log(coefficient);\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tif (msgCounter === 1) {\r\n\t\t\t\tconsole.log('fud');\r\n\t\t\t//\ttpl.draw(data, \"viewport\", undefined, coefficient, true);\r\n\t\t\t\tmap.draw(data, \"viewport\", undefined, coefficient, true);\r\n\t\t\t} else {\r\n\t\t\t//\ttpl.draw(data, \"viewport\", undefined, coefficient);\r\n\t\t\t\tmap.draw(data, \"viewport\", undefined, coefficient);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconsole.log(\"Other message received\\n\", e.data);\r\n\t\t}\r\n\t}\r\n\tfunction onerror(e) {\r\n\t\tconsole.log(\"WebSocket Error: \" , e);\r\n\t\t\r\n\t\tcloseModal();\r\n\t\t\r\n\t\tnoteMsgs.init.close();\r\n\t\t// noteMsgs.processing.close();\r\n\t\t\r\n\t\tnote.error('Socket error.');\r\n\t\t\r\n\t}\r\n\tfunction onclose(e) {\r\n\t\tconsole.log(\"Connection closed\", e);\r\n\t\twuk.enable(scanBtn);\r\n\t\t\r\n\t\t\r\n\t\tnoteMsgs.init.close();\r\n\t\t\r\n\t\tvar process = noteMsgs.processing;\r\n\t\tif (process) {\r\n\t\t\tprocess.close();\r\n\t\t}\r\n\t\t\r\n\t\tnote.info('Socket closed.', 2000);\r\n\r\n\t}\r\n\tfunction addHandlers(fn) {\r\n\t\topenCallback = fn;\r\n\t\t\r\n\t\tws.onopen = onopen;\r\n\t\tws.onmessage = onmessage;\r\n\t\tws.onerror = onerror;\r\n\t\tws.onclose = onclose;\r\n\t}\r\n\tfunction createSock(opt) {\r\n\t\tif (opt) { \r\n\t\t\tpath += '?portscanner=true';\r\n\t\t}\r\n\t\tws = new WebSocket(path);\r\n\t\tconsole.log(ws);\r\n\t}\r\n\tfunction trace(arr, opt) {\r\n\t\tnoteMsgs.init = wuk.note.process('Opening socket...', false, 'top-center');\r\n\t\t\r\n\t\twuk.disable(scanBtn);\r\n\t\t\r\n\t\tcreateSock(opt);\r\n\t\taddHandlers(function () {\r\n\t\t\tws.send( JSON.stringify(arr) );\r\n\t\t});\r\n\t\t\r\n\t}\r\n\tfunction init() {\r\n\t\tscanBtn = $('#traceroute_scan');\r\n\t\tcancelBtn = $('#abort');\r\n\t\t\r\n\t\tscanBtn.on('click', function (e) {\r\n\t\t\tvar txtarea, checkbox, txt, arr;\r\n\t\t\t\r\n\t\t\te.preventDefault();\r\n\t\t\t\r\n\t\t\ttxtarea = $('#txtarea_thing');\r\n\t\t\tcheckbox = $('input[type=\"checkbox\"][name=\"secure\"]').is(':checked');\r\n\t\t\t\r\n\t\t\ttxt = txtarea.val().trim();\r\n\t\t\tif (txt) {\r\n\t\t\t\tarr = txt.split(\"\\n\");\r\n\t\t\t\t//console.log(arr, checkbox);\r\n\t\t\t\t\r\n\t\t\t\ttrace(arr, checkbox);\r\n\t\t\t//\tmockTrace.trace();\r\n\t\t\t}\r\n\t\t\tcancelBtn.removeAttr('disabled');\r\n\t\t});\r\n\t\tcancelBtn.on('click', function (e) {\r\n\t\t\te.preventDefault();\r\n\t\t\tabort();\r\n\t\t});\r\n\t}\r\n\t\r\n\treturn {\r\n\t\tabort: abort,\r\n\t\ttrace: trace,\r\n\t\tbegin: begin,\r\n\t\tinit: init\r\n\t};\r\n\t\r\n});"]}